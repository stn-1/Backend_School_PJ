<script>
let socket;
let myId = ""; // ID của chính mình
let roomId = "YOUR_ROOM_ID"; // ví dụ: "6501abc..." 
let loadingHistory = false;
let hasMore = true; // còn tin cũ hay không
const limit = 20; // fetch 20 tin mỗi lần

// -------------------------
// 1. Kết nối socket
// -------------------------
function connect() {
  const idInput = document.getElementById("userIdInput").value.trim();
  if (!idInput) return alert("Cần nhập ID!");

  myId = idInput;

  if (socket) socket.disconnect();

  socket = io("https://backend-school-pj-1.onrender.com", {
    auth: { userId: myId },
    transports: ["websocket"],
  });

  socket.on("connect", () => {
    document.getElementById("login").style.display = "none";
    document.getElementById("chat-container").style.display = "flex";

    // Lần đầu load lịch sử
    loadMessages();
  });

  socket.on("new_message", (data) => addMessageToScreen(data, false));
}

// -------------------------
// 2. Load lịch sử tin nhắn
// -------------------------
async function loadMessages(before = null) {
  if (loadingHistory || !hasMore) return;
  loadingHistory = true;

  let url = `https://backend-school-pj-1.onrender.com/api/${roomId}/messages?limit=${limit}`;
  if (before) url += `&before=${before}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    const list = document.getElementById("messages");

    // prepend tin nhắn cũ lên đầu
    data.messages.forEach(msg => addMessageToScreen(msg, true));

    hasMore = data.hasMore;

  } catch (err) {
    console.error(err);
  } finally {
    loadingHistory = false;
  }
}

// -------------------------
// 3. Thêm tin nhắn lên màn hình
// prepend = true => chèn ở đầu
// -------------------------
function addMessageToScreen(data, prepend = false) {
  const list = document.getElementById("messages");
  const div = document.createElement("div");

  const isMe = data.senderId === myId;
  const displayName = isMe ? "Me" : data.senderName;

  div.className = isMe ? "message-wrapper msg-me" : "message-wrapper msg-other";
  div.innerHTML = `
      <div class="name">${displayName}</div>
      <div class="bubble">${data.content}</div>
  `;

  if (prepend) {
    list.prepend(div);
  } else {
    list.appendChild(div);
    list.scrollTop = list.scrollHeight; // scroll xuống cuối
  }
}

// -------------------------
// 4. Gửi tin nhắn
// -------------------------
function send() {
  const input = document.getElementById("msgInput");
  if (input.value && socket) {
    socket.emit("send_message", input.value); // socket event mới
    input.value = "";
  }
}

function handleEnter(e) {
  if (e.key === "Enter") send();
}

// -------------------------
// 5. Infinite scroll để fetch tin nhắn cũ
// -------------------------
document.getElementById("messages").addEventListener("scroll", () => {
  const list = document.getElementById("messages");
  if (list.scrollTop < 100 && hasMore && !loadingHistory) {
    // lấy createdAt của tin cũ nhất
    const firstMsg = list.firstChild;
    const cursor = firstMsg?.dataset?.createdAt || null;
    loadMessages(cursor);
  }
});
</script>
