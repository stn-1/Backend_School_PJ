<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat: Me vs User Name</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f0f2f5;
        padding: 20px;
      }

      /* Giao diện Chat */
      #chat-container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 80vh;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Style từng dòng tin nhắn */
      .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 70%;
      }

      /* -- 1. TIN NHẮN CỦA NGƯỜI KHÁC -- */
      .msg-other {
        align-self: flex-start;
      }

      .msg-other .name {
        font-size: 12px;
        color: #555;
        margin-left: 10px;
        margin-bottom: 2px;
      }

      .msg-other .bubble {
        background: #e4e6eb;
        color: black;
        border-radius: 18px 18px 18px 4px;
        padding: 8px 12px;
      }

      /* -- 2. TIN NHẮN CỦA MÌNH (ME) -- */
      .msg-me {
        align-self: flex-end;
      }

      .msg-me .name {
        font-size: 12px;
        color: #0084ff;
        margin-right: 10px;
        margin-bottom: 2px;
        text-align: right;
        font-weight: bold;
      }

      .msg-me .bubble {
        background: #0084ff;
        color: white;
        border-radius: 18px 18px 4px 18px;
        padding: 8px 12px;
      }

      /* Input area */
      .input-area {
        padding: 10px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
      }
      input {
        flex: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid #ccc;
        outline: none;
      }
      button {
        padding: 10px 20px;
        border-radius: 20px;
        border: none;
        background: #0084ff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        opacity: 0.9;
      }

      /* Login fake */
      #login {
        text-align: center;
        margin-top: 50px;
      }
      
      /* Style riêng cho ô input login */
      #login input {
        display: block; 
        margin: 10px auto; 
        width: 300px;
        flex: none; /* Reset flex property của input chung */
      }
    </style>
  </head>
  <body>
    <!-- 1. Màn hình nhập thông tin (Đã sửa) -->
    <div id="login">
      <h3>Nhập thông tin để test</h3>
      
      <!-- Nhập Room ID -->
      <input id="roomIdInput" placeholder="Paste Room ID (MongoDB _id) vào đây..." />
      
      <!-- Nhập User ID -->
      <input id="userIdInput" placeholder="Paste User ID (MongoDB _id) vào đây..." />
      
      <button onclick="connect()">Vào Chat</button>
    </div>

    <!-- 2. Màn hình Chat -->
    <div id="chat-container" style="display: none">
      <div
        style="
          padding: 15px;
          background: #0084ff;
          color: white;
          font-weight: bold;
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <span>Chat Room</span>
        <button onclick="location.reload()" style="padding: 5px 10px; font-size: 12px; background: rgba(0,0,0,0.2);">Thoát</button>
      </div>
      <div id="messages"></div>
      <div class="input-area">
        <input
          id="msgInput"
          placeholder="Nhập tin nhắn..."
          onkeypress="handleEnter(event)"
        />
        <button onclick="send()">Gửi</button>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
      let socket;
      let myId = ""; 
      let roomId = ""; // Không fix cứng nữa, chờ nhập từ input
      let loadingHistory = false;
      let hasMore = true;
      const limit = 20; 

      // -------------------------
      // 1. Kết nối socket
      // -------------------------
      function connect() {
        const rInput = document.getElementById("roomIdInput").value.trim();
        const uInput = document.getElementById("userIdInput").value.trim();

        // Kiểm tra xem đã nhập đủ chưa
        if (!rInput || !uInput) {
          return alert("Vui lòng nhập đầy đủ Room ID và User ID!");
        }

        // Gán giá trị vào biến toàn cục
        roomId = rInput;
        myId = uInput;

        if (socket) socket.disconnect();

        // Kết nối Socket
        socket = io("https://backend-school-pj-1.onrender.com", {
          auth: { userId: myId }, // Backend có thể dùng hoặc không, tùy code của bạn
          query: { roomId: roomId }, // Gửi roomId lên nếu backend cần check lúc handshake
          transports: ["websocket"],
        });

        socket.on("connect_error", (err) => {
          console.error("Lỗi kết nối:", err.message);
          alert("Kết nối thất bại: " + err.message);
        });

        socket.on("connect", () => {
          console.log("Đã kết nối Socket!");
          
          // Ẩn màn hình Login, hiện Chat
          document.getElementById("login").style.display = "none";
          document.getElementById("chat-container").style.display = "flex";

          // Emit event join_room nếu backend yêu cầu (Thường là cần thiết)
          // socket.emit("join_room", roomId); 

          // Xóa tin nhắn cũ (nếu có do lần test trước)
          document.getElementById("messages").innerHTML = "";
          
          // Load lịch sử tin nhắn
          loadMessages();
        });

        socket.on("new_message", (data) => addMessageToScreen(data, false));
      }

      // -------------------------
      // 2. Load lịch sử tin nhắn
      // -------------------------
      async function loadMessages(before = null) {
        if (loadingHistory || !hasMore) return;
        loadingHistory = true;

        // URL giờ sẽ dùng biến roomId thật sự
        let url = `https://backend-school-pj-1.onrender.com/api/${roomId}/messages?limit=${limit}`;
        if (before) url += `&before=${before}`;

        try {
          console.log("Đang gọi API lấy tin nhắn:", url);
          const res = await fetch(url);
          
          if (!res.ok) {
            throw new Error(`Lỗi API: ${res.status} - ${res.statusText}`);
          }

          const data = await res.json();

          // prepend tin nhắn cũ lên đầu
          if (data.messages && Array.isArray(data.messages)) {
             data.messages.forEach(msg => addMessageToScreen(msg, true));
             hasMore = data.hasMore;
          } else {
             console.warn("API không trả về mảng messages hợp lệ", data);
          }

        } catch (err) {
          console.error("Lỗi tải tin nhắn:", err);
          alert("Không lấy được tin nhắn. Kiểm tra lại Room ID.");
        } finally {
          loadingHistory = false;
        }
      }

      // -------------------------
      // 3. Thêm tin nhắn lên màn hình
      // -------------------------
      function addMessageToScreen(data, prepend = false) {
        const list = document.getElementById("messages");
        const div = document.createElement("div");

        const isMe = data.senderId === myId;
        const displayName = isMe ? "Me" : (data.senderName || "User");

        div.className = isMe ? "message-wrapper msg-me" : "message-wrapper msg-other";
        
        // Xử lý hiển thị nội dung tin nhắn an toàn (tránh XSS)
        const safeContent = data.content ? data.content.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";

        div.innerHTML = `
            <div class="name">${displayName}</div>
            <div class="bubble">${safeContent}</div>
        `;
        
        // Lưu createdAt vào dataset để dùng cho infinite scroll
        if (data.createdAt) {
            div.dataset.createdAt = data.createdAt;
        }

        if (prepend) {
          list.prepend(div);
        } else {
          list.appendChild(div);
          list.scrollTop = list.scrollHeight; 
        }
      }

      // -------------------------
      // 4. Gửi tin nhắn
      // -------------------------
      function send() {
        const input = document.getElementById("msgInput");
        const text = input.value.trim();
        
        if (text && socket) {
          // Gửi sự kiện lên server
          // Lưu ý: Cấu trúc data gửi đi phải khớp với Backend
          const msgData = {
            roomId: roomId,
            content: text,
            senderId: myId // Nếu backend cần
          };

          socket.emit("send_message", msgData); 
          input.value = "";
        }
      }

      function handleEnter(e) {
        if (e.key === "Enter") send();
      }

      // -------------------------
      // 5. Infinite scroll
      // -------------------------
      document.getElementById("messages").addEventListener("scroll", () => {
        const list = document.getElementById("messages");
        if (list.scrollTop < 50 && hasMore && !loadingHistory) {
          const firstMsg = list.firstChild;
          const cursor = firstMsg?.dataset?.createdAt || null;
          if (cursor) {
              loadMessages(cursor);
          }
        }
      });
    </script>
  </body>
</html>