<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat: Me vs User Name</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f0f2f5;
        padding: 20px;
      }

      /* Giao diện Chat */
      #chat-container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 80vh;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Style từng dòng tin nhắn */
      .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 70%;
      }

      /* -- 1. TIN NHẮN CỦA NGƯỜI KHÁC -- */
      .msg-other {
        align-self: flex-start;
      }

      .msg-other .name {
        font-size: 12px;
        color: #555;
        margin-left: 10px;
        margin-bottom: 2px;
      }

      .msg-other .bubble {
        background: #e4e6eb;
        color: black;
        border-radius: 18px 18px 18px 4px;
        padding: 8px 12px;
      }

      /* -- 2. TIN NHẮN CỦA MÌNH (ME) -- */
      .msg-me {
        align-self: flex-end;
      }

      .msg-me .name {
        font-size: 12px;
        color: #0084ff;
        margin-right: 10px;
        margin-bottom: 2px;
        text-align: right;
        font-weight: bold;
      }

      .msg-me .bubble {
        background: #0084ff;
        color: white;
        border-radius: 18px 18px 4px 18px;
        padding: 8px 12px;
      }

      /* Input area */
      .input-area {
        padding: 10px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
      }
      input {
        flex: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid #ccc;
        outline: none;
      }
      button {
        padding: 10px 20px;
        border-radius: 20px;
        border: none;
        background: #0084ff;
        color: white;
        cursor: pointer;
      }

      /* Login fake */
      #login {
        text-align: center;
        margin-top: 50px;
      }
    </style>
  </head>
  <body>
    <!-- Màn hình nhập ID giả lập -->
    <div id="login">
      <h3>Nhập MongoDB _id của bạn để test</h3>
      <input id="userIdInput" placeholder="Paste _id vào đây..." />
      <button onclick="connect()">Vào Chat</button>
    </div>

    <!-- Màn hình Chat -->
    <div id="chat-container" style="display: none">
      <div
        style="
          padding: 15px;
          background: #0084ff;
          color: white;
          font-weight: bold;
        "
      >
        Chat Room
      </div>
      <div id="messages"></div>
      <div class="input-area">
        <input
          id="msgInput"
          placeholder="Nhập tin nhắn..."
          onkeypress="handleEnter(event)"
        />
        <button onclick="send()">Gửi</button>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
let socket;
let myId = ""; // ID của chính mình
let roomId = "YOUR_ROOM_ID"; // ví dụ: "6501abc..." 
let loadingHistory = false;
let hasMore = true; // còn tin cũ hay không
const limit = 20; // fetch 20 tin mỗi lần

// -------------------------
// 1. Kết nối socket
// -------------------------
function connect() {
  const idInput = document.getElementById("userIdInput").value.trim();
  if (!idInput) return alert("Cần nhập ID!");

  myId = idInput;

  if (socket) socket.disconnect();

  socket = io("https://backend-school-pj-1.onrender.com", {
    auth: { userId: myId },
    transports: ["websocket"],
  });

  socket.on("connect", () => {
    document.getElementById("login").style.display = "none";
    document.getElementById("chat-container").style.display = "flex";

    // Lần đầu load lịch sử
    loadMessages();
  });

  socket.on("new_message", (data) => addMessageToScreen(data, false));
}

// -------------------------
// 2. Load lịch sử tin nhắn
// -------------------------
async function loadMessages(before = null) {
  if (loadingHistory || !hasMore) return;
  loadingHistory = true;

  let url = `https://backend-school-pj-1.onrender.com/api/${roomId}/messages?limit=${limit}`;
  if (before) url += `&before=${before}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    const list = document.getElementById("messages");

    // prepend tin nhắn cũ lên đầu
    data.messages.forEach(msg => addMessageToScreen(msg, true));

    hasMore = data.hasMore;

  } catch (err) {
    console.error(err);
  } finally {
    loadingHistory = false;
  }
}

// -------------------------
// 3. Thêm tin nhắn lên màn hình
// prepend = true => chèn ở đầu
// -------------------------
function addMessageToScreen(data, prepend = false) {
  const list = document.getElementById("messages");
  const div = document.createElement("div");

  const isMe = data.senderId === myId;
  const displayName = isMe ? "Me" : data.senderName;

  div.className = isMe ? "message-wrapper msg-me" : "message-wrapper msg-other";
  div.innerHTML = `
      <div class="name">${displayName}</div>
      <div class="bubble">${data.content}</div>
  `;

  if (prepend) {
    list.prepend(div);
  } else {
    list.appendChild(div);
    list.scrollTop = list.scrollHeight; // scroll xuống cuối
  }
}

// -------------------------
// 4. Gửi tin nhắn
// -------------------------
function send() {
  const input = document.getElementById("msgInput");
  if (input.value && socket) {
    socket.emit("send_message", input.value); // socket event mới
    input.value = "";
  }
}

function handleEnter(e) {
  if (e.key === "Enter") send();
}

// -------------------------
// 5. Infinite scroll để fetch tin nhắn cũ
// -------------------------
document.getElementById("messages").addEventListener("scroll", () => {
  const list = document.getElementById("messages");
  if (list.scrollTop < 100 && hasMore && !loadingHistory) {
    // lấy createdAt của tin cũ nhất
    const firstMsg = list.firstChild;
    const cursor = firstMsg?.dataset?.createdAt || null;
    loadMessages(cursor);
  }
});
</script>

  </body>
</html>
